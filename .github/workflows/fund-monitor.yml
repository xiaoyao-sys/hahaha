name: hahaha

on:
  schedule:
    - cron: '0 6 * * 1-5'  # 每天UTC时间6:00执行（北京时间14:00），仅工作日（周一到周五）
    - cron: '30 6 * * 1-5'   # 每天UTC时间6:30执行（北京时间14:30），仅工作日（周一到周五）
  workflow_dispatch:  # 允许手动触发
  push:
    branches: [ main ]
    paths:
      - 'final_lof_fund_scraper.py'
      - 'fund_limit_fetcher.py'
      - 'config.ini'

jobs:
  monitor-funds:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8]
    
    steps:
    - name: Checkout代码
      uses: actions/checkout@v3
      
    - name: 设置Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        
    - name: 检查文件结构
      run: |
        echo "当前目录内容:"
        ls -la
        echo "检查必要文件是否存在:"
        if [ -f "final_lof_fund_scraper.py" ]; then echo "✓ final_lof_fund_scraper.py 存在"; else echo "✗ final_lof_fund_scraper.py 不存在"; fi
        if [ -f "fund_limit_fetcher.py" ]; then echo "✓ fund_limit_fetcher.py 存在"; else echo "✗ fund_limit_fetcher.py 不存在"; fi
        if [ -f "config.ini" ]; then echo "✓ config.ini 存在"; else echo "✗ config.ini 不存在"; fi
        if [ -f "requirements.txt" ]; then echo "✓ requirements.txt 存在"; else echo "✗ requirements.txt 不存在"; fi
        
    - name: 安装依赖（尝试多种方法）
      run: |
        python -m pip install --upgrade pip
        
        # 方法1：尝试安装requirements.txt中的依赖
        if [ -f "requirements.txt" ]; then
          echo "尝试安装requirements.txt中的依赖..."
          pip install -r requirements.txt || echo "方法1失败，尝试方法2..."
        fi
        
        # 方法2：如果方法1失败，逐个安装依赖
        if ! python -c "import requests" 2>/dev/null; then
          echo "安装requests..."
          pip install requests
        fi
        
        if ! python -c "import bs4" 2>/dev/null; then
          echo "安装beautifulsoup4..."
          pip install beautifulsoup4
        fi
        
        if ! python -c "import akshare" 2>/dev/null; then
          echo "安装akshare..."
          pip install akshare
        fi
        
        if ! python -c "import pandas" 2>/dev/null; then
          echo "安装pandas..."
          pip install pandas
        fi
        
        if ! python -c "import lxml" 2>/dev/null; then
          echo "安装lxml..."
          pip install lxml
        fi
        
    - name: 检查Python包安装
      run: |
        echo "检查已安装的Python包:"
        python -c "import requests; print('requests版本:', requests.__version__)"
        python -c "import bs4; print('beautifulsoup4版本:', bs4.__version__)"
        python -c "import akshare; print('akshare版本:', akshare.__version__)"
        python -c "import pandas; print('pandas版本:', pandas.__version__)"
        python -c "import lxml; print('lxml版本:', lxml.__version__)"

    - name: 检查配置文件
      run: |
        if [ ! -f "config.ini" ]; then
          echo "错误: 找不到config.ini配置文件"
          exit 1
        fi
        echo "config.ini内容:"
        cat config.ini
        
    - name: 运行基金监控程序
      env:
        WECHAT_WEBHOOK_KEY: ${{ secrets.WECHAT_WEBHOOK_KEY }}
      run: |
        # 如果环境变量中有webhook key，则更新配置文件
        if [ -n "$WECHAT_WEBHOOK_KEY" ]; then
          echo "使用GitHub Secrets中的webhook key"
          sed -i "s/webhook_key = .*/webhook_key = $WECHAT_WEBHOOK_KEY/" config.ini
        else
          echo "使用config.ini文件中的webhook key"
        fi
        
        echo "运行前检查:"
        echo "当前目录内容:"
        ls -la
        
        # 执行主程序
        echo "开始执行基金监控程序..."
        python final_lof_fund_scraper.py
